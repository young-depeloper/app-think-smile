<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Think&Smile - Изучение слов</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4255ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Think&Smile">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4255ff;
            --primary-light: #e8ebff;
            --secondary: #ffcd1f;
            --dark: #303545;
            --light: #f6f7fb;
            --success: #4caf50;
            --danger: #ff5252;
            --gray: #939bb4;
            --bg-color: #f6f7fb;
            --text-color: #303545;
            --card-bg: white;
            --sidebar-bg: white;
            --border-color: #e0e0e0;
            --easy-color: #4caf50;
            --medium-color: #ff9800;
            --hard-color: #f44336;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --card-bg: #2d2d2d;
            --sidebar-bg: #252525;
            --border-color: #404040;
            --light: #2d2d2d;
            --dark: #ffffff;
            --gray: #a0a0a0;
            --primary-light: #2d3748;
            --easy-color: #388e3c;
            --medium-color: #f57c00;
            --hard-color: #d32f2f;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Сайдбар */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
            transition: all 0.3s;
            border-right: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo h1 {
            font-size: 24px;
            color: var(--primary);
            margin-left: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .theme-switcher {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
        }

        .create-set-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .create-set-btn:hover {
            background-color: #3241cc;
        }

        .create-set-btn i {
            margin-right: 8px;
        }

        .sets-list {
            margin-top: 20px;
        }

        .set-item {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .set-item:hover {
            background-color: var(--primary-light);
        }

        .set-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .set-icon {
            width: 24px;
            height: 24px;
            background-color: var(--secondary);
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .set-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .set-item:hover .set-actions {
            opacity: 1;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: var(--gray);
            transition: color 0.2s;
        }

        .action-btn:hover {
            color: var(--text-color);
        }

        .delete-btn:hover {
            color: var(--danger);
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mode-selector {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .mode-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .mode-btn.active {
            background-color: var(--primary);
            color: white;
        }

        /* Новые стили для режима списка и транскрипции */
        .view-mode-selector {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            margin-left: 10px;
        }

        .view-mode-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-mode-btn.active {
            background-color: var(--primary);
            color: white;
        }

        /* Поиск и фильтрация */
        .search-filter-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: none;
            border: 2px solid var(--primary-light);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .filter-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-btn.easy.active {
            background-color: var(--easy-color);
            border-color: var(--easy-color);
        }

        .filter-btn.medium.active {
            background-color: var(--medium-color);
            border-color: var(--medium-color);
        }

        .filter-btn.hard.active {
            background-color: var(--hard-color);
            border-color: var(--hard-color);
        }

        .search-results-info {
            margin-top: 10px;
            color: var(--gray);
            font-size: 14px;
        }

        /* Карточки */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card.easy {
            border-left: 4px solid var(--easy-color);
        }

        .card.medium {
            border-left: 4px solid var(--medium-color);
        }

        .card.hard {
            border-left: 4px solid var(--hard-color);
        }

        .card-term {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-definition {
            color: var(--gray);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-difficulty {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .srs-stage {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            background-color: var(--success);
            color: white;
        }

        .card-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .card:hover .card-actions {
            opacity: 1;
        }

        .transcription {
            color: var(--primary);
            font-size: 14px;
            font-style: italic;
            margin: 5px 0;
        }

        .card-audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            color: var(--primary);
            transition: all 0.2s;
            font-size: 16px;
        }

        .card-audio-btn:hover {
            background-color: var(--primary-light);
            transform: scale(1.1);
        }

        .difficulty-selector {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .difficulty-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .difficulty-btn.easy {
            color: var(--easy-color);
            border: 1px solid var(--easy-color);
        }

        .difficulty-btn.easy.active {
            background-color: var(--easy-color);
            color: white;
        }

        .difficulty-btn.medium {
            color: var(--medium-color);
            border: 1px solid var(--medium-color);
        }

        .difficulty-btn.medium.active {
            background-color: var(--medium-color);
            color: white;
        }

        .difficulty-btn.hard {
            color: var(--hard-color);
            border: 1px solid var(--hard-color);
        }

        .difficulty-btn.hard.active {
            background-color: var(--hard-color);
            color: white;
        }

        .add-card-btn {
            background-color: transparent;
            border: 2px dashed var(--gray);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray);
        }

        .add-card-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .add-card-btn i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Стили для списка карточек */
        .cards-list {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .list-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .list-item:hover {
            background-color: var(--primary-light);
        }

        .list-item.easy {
            border-left: 4px solid var(--easy-color);
        }

        .list-item.medium {
            border-left: 4px solid var(--medium-color);
        }

        .list-item.hard {
            border-left: 4px solid var(--hard-color);
        }

        .list-item-content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .list-term {
            font-weight: 600;
            font-size: 16px;
            min-width: 150px;
        }

        .list-transcription {
            color: var(--primary);
            font-size: 14px;
            font-style: italic;
            min-width: 120px;
        }

        .list-definition {
            color: var(--gray);
            flex: 1;
        }

        .list-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .audio-btn-small {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            color: var(--primary);
            transition: all 0.2s;
            font-size: 16px;
        }

        .audio-btn-small:hover {
            background-color: var(--primary-light);
            transform: scale(1.1);
        }

        /* Статистика */
        .stats-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .stats-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s ease;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--text-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3241cc;
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e04141;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        /* Режим обучения */
        .study-container {
            display: none;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .study-container.active {
            display: block;
        }

        .study-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .study-header h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .study-progress {
            color: var(--gray);
        }

        .study-type-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .study-type-btn {
            padding: 8px 16px;
            background: none;
            border: 2px solid var(--primary-light);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .study-type-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .question {
            font-size: 24px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 60px;
            color: var(--text-color);
        }

        .audio-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-left: 10px;
            color: var(--primary);
            transition: transform 0.2s;
        }

        .audio-btn:hover {
            transform: scale(1.1);
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .option {
            background-color: var(--light);
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .option:hover {
            background-color: var(--primary-light);
        }

        .option.correct {
            background-color: var(--success);
            color: white;
        }

        .option.incorrect {
            background-color: var(--danger);
            color: white;
        }

        .study-actions {
            display: flex;
            justify-content: space-between;
        }

        .srs-rating-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .srs-rating-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .srs-rating-btn.again {
            background-color: var(--danger);
            color: white;
        }

        .srs-rating-btn.hard {
            background-color: var(--medium-color);
            color: white;
        }

        .srs-rating-btn.good {
            background-color: var(--success);
            color: white;
        }

        .srs-rating-btn.easy {
            background-color: var(--primary);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--border-color);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .warning-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* Уведомления внизу экрана */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transition: transform 0.3s, opacity 0.3s;
            opacity: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.info {
            background-color: var(--primary);
        }

        /* Сложные слова */
        .difficult-words {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .difficult-words h3 {
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .difficult-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .difficult-word {
            background-color: var(--danger);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .options {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .search-box {
                flex-direction: column;
            }

            .filter-buttons {
                justify-content: center;
            }

            .view-mode-selector {
                margin-left: 0;
                margin-top: 10px;
            }

            .list-item-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .list-term, .list-transcription {
                min-width: auto;
            }

            .study-type-selector {
                flex-direction: column;
                align-items: center;
            }

            .srs-rating-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Сайдбар -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">T&S</div>
            <h1>Think&Smile</h1>
            <button class="theme-switcher" id="themeSwitcher">🌙</button>
        </div>
        
        <button class="create-set-btn" id="createSetBtn">
            <i>+</i> Создать набор
        </button>

        <button class="create-set-btn" id="addPredefinedSetBtn" style="background-color: var(--success);">
            <i>📚</i> Готовые наборы
        </button>
        
        <div class="sets-list" id="setsList">
            <!-- Наборы будут добавляться здесь -->
        </div>
    </div>
    
    <!-- Основной контент -->
    <div class="main-content">
        <div class="header">
            <h2 id="currentSetName">Выберите набор</h2>
            <div class="header-actions">
                <div class="mode-selector">
                    <button class="mode-btn active" id="cardsModeBtn">Карточки</button>
                    <button class="mode-btn" id="studyModeBtn">Заучивание</button>
                    <button class="mode-btn" id="statsModeBtn">Статистика</button>
                </div>
                <div class="view-mode-selector" id="viewModeSelector" style="display: none;">
                    <button class="view-mode-btn active" data-view="cards">
                        <span>🃏</span> Карточки
                    </button>
                    <button class="view-mode-btn" data-view="list">
                        <span>📋</span> Список
                    </button>
                </div>
                <div class="export-import">
                    <button class="btn btn-secondary" id="exportBtn">Экспорт</button>
                    <button class="btn btn-secondary" id="importBtn">Импорт</button>
                </div>
            </div>
        </div>

        <!-- Поиск и фильтрация -->
        <div class="search-filter-container" id="searchFilterContainer" style="display: none;">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Поиск по словам и переводам...">
                <button class="btn btn-secondary" id="clearSearchBtn">Очистить</button>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Все слова</button>
                <button class="filter-btn easy" data-filter="easy">Легкие</button>
                <button class="filter-btn medium" data-filter="medium">Средние</button>
                <button class="filter-btn hard" data-filter="hard">Сложные</button>
            </div>
            <div class="search-results-info" id="searchResultsInfo">
                Найдено карточек: 0
            </div>
        </div>
        
        <!-- Контейнер для карточек -->
        <div class="cards-container" id="cardsContainer">
            <!-- Карточки будут добавляться здесь -->
        </div>

        <!-- Контейнер для списка карточек -->
        <div class="cards-list" id="cardsList">
            <!-- Список карточек будет добавляться здесь -->
        </div>
        
        <!-- Контейнер для статистики -->
        <div class="stats-container" id="statsContainer" style="display: none;">
            <div class="stats-header">
                <h3>Статистика обучения</h3>
            </div>
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="totalCards">0</div>
                    <div class="stat-label">Всего карточек</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="learnedCards">0</div>
                    <div class="stat-label">Изучено</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="learnedProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="difficultCards">0</div>
                    <div class="stat-label">Сложные слова</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Успешность</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dueCards">0</div>
                    <div class="stat-label">Для повторения</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="masteredCards">0</div>
                    <div class="stat-label">Усвоено</div>
                </div>
            </div>
            
            <div class="difficult-words" id="difficultWordsSection" style="display: none; margin-top: 20px;">
                <h3>Сложные слова для повторения</h3>
                <div class="difficult-list" id="difficultWordsList">
                    <!-- Сложные слова будут здесь -->
                </div>
            </div>
        </div>
        
        <!-- Контейнер для режима заучивания -->
        <div class="study-container" id="studyContainer">
            <div class="study-header">
                <h3>Режим заучивания</h3>
                <div class="study-type-selector">
                    <button class="study-type-btn active" data-type="mixed">Смешанный</button>
                    <button class="study-type-btn" data-type="en-ru">Английский → Русский</button>
                    <button class="study-type-btn" data-type="ru-en">Русский → Английский</button>
                    <button class="study-type-btn" data-type="typing">Печать</button>
                    <button class="study-type-btn" data-type="audio">Озвучка</button>
                    <button class="study-type-btn" data-type="difficult">Сложные слова</button>
                    <button class="study-type-btn" data-type="srs">Интервальное повторение</button>
                </div>
                <div class="study-progress" id="studyProgress">Вопрос 1 из 4</div>
            </div>
            
            <div class="question" id="studyQuestion">
                Как переводится слово "apple"?
            </div>
            
            <div class="options" id="studyOptions">
                <!-- Варианты ответов будут добавляться здесь -->
            </div>

            <div class="typing-input-container" id="typingInputContainer" style="display: none; text-align: center; margin-bottom: 20px;">
                <input type="text" id="typingAnswer" class="form-control" style="max-width: 300px; margin: 0 auto;" placeholder="Введите перевод...">
                <button class="btn btn-primary" id="checkTypingAnswer" style="margin-top: 10px;">Проверить</button>
            </div>

            <div class="audio-container" id="audioContainer" style="display: none; text-align: center; margin-bottom: 20px;">
                <p style="margin-bottom: 15px; font-size: 18px;">Прослушайте слово и выберите правильный перевод:</p>
                <button class="audio-btn" id="playAudioBtn" title="Прослушать слово">🔊</button>
                <div class="options" id="audioOptions" style="margin-top: 20px;">
                    <!-- Варианты ответов для аудио режима -->
                </div>
            </div>

            <div class="srs-rating-buttons" id="srsRatingButtons" style="display: none;">
                <button class="srs-rating-btn again" data-rating="again">Снова</button>
                <button class="srs-rating-btn hard" data-rating="hard">Трудно</button>
                <button class="srs-rating-btn good" data-rating="good">Хорошо</button>
                <button class="srs-rating-btn easy" data-rating="easy">Легко</button>
            </div>
            
            <div class="study-actions">
                <button class="btn btn-secondary" id="prevQuestionBtn">Назад</button>
                <button class="btn btn-primary" id="nextQuestionBtn">Далее</button>
            </div>
        </div>
        
        <!-- Состояние при пустом наборе -->
        <div class="empty-state" id="emptyState">
            <i>📚</i>
            <h3>Набор пуст</h3>
            <p>Добавьте карточки, чтобы начать изучение</p>
        </div>
    </div>
    
    <!-- Модальное окно создания набора -->
    <div class="modal" id="createSetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Создать новый набор</h3>
                <button class="close-btn" id="closeCreateSetModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="setName">Название набора</label>
                <input type="text" id="setName" class="form-control" placeholder="Например, Фрукты">
                <div class="warning-message" id="setNameWarning">Пожалуйста, введите название набора</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCreateSet">Отмена</button>
                <button class="btn btn-primary" id="saveSet">Создать</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно создания/редактирования карточки -->
    <div class="modal" id="createCardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="cardModalTitle">Добавить карточку</h3>
                <button class="close-btn" id="closeCreateCardModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="cardTerm">Термин (английский)</label>
                <input type="text" id="cardTerm" class="form-control" placeholder="Например, apple">
                <div class="warning-message" id="cardTermWarning">Пожалуйста, введите термин</div>
            </div>
            <div class="form-group">
                <label for="cardDefinition">Определение (русский)</label>
                <input type="text" id="cardDefinition" class="form-control" placeholder="Например, яблоко">
                <div class="warning-message" id="cardDefinitionWarning">Пожалуйста, введите определение</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCreateCard">Отмена</button>
                <button class="btn btn-primary" id="saveCard">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования набора -->
    <div class="modal" id="editSetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Редактировать набор</h3>
                <button class="close-btn" id="closeEditSetModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editSetName">Название набора</label>
                <input type="text" id="editSetName" class="form-control" placeholder="Например, Фрукты">
                <div class="warning-message" id="editSetNameWarning">Пожалуйста, введите название набора</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelEditSet">Отмена</button>
                <button class="btn btn-primary" id="saveEditSet">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="deleteModalTitle">Подтверждение удаления</h3>
                <button class="close-btn" id="closeConfirmDeleteModal">&times;</button>
            </div>
            <div class="form-group">
                <p id="deleteModalMessage">Вы уверены, что хотите удалить этот набор? Это действие нельзя отменить.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelDelete">Отмена</button>
                <button class="btn btn-danger" id="confirmDelete">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно экспорта -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Экспорт набора</h3>
                <button class="close-btn" id="closeExportModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Формат экспорта:</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary export-format-btn active" data-format="json">JSON</button>
                    <button class="btn btn-secondary export-format-btn" data-format="txt">TXT</button>
                </div>
                <label for="exportContent">Содержимое:</label>
                <textarea id="exportContent" class="form-control" rows="10" readonly style="resize: vertical; font-family: monospace;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelExport">Отмена</button>
                <button class="btn btn-primary" id="downloadExport">Скачать</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно импорта -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Импорт набора</h3>
                <button class="close-btn" id="closeImportModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Формат импорта:</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary import-format-btn active" data-format="json">JSON</button>
                    <button class="btn btn-secondary import-format-btn" data-format="txt">TXT</button>
                </div>
                <label>Выберите файл для импорта:</label>
                <input type="file" id="importFileInput" class="form-control" accept=".json,.txt">
                <div class="warning-message" id="importFileWarning" style="display: none;"></div>
            </div>
            <div class="form-group" id="importPreview" style="display: none;">
                <label>Предпросмотр набора:</label>
                <div style="background: var(--light); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <strong>Название:</strong> <span id="previewSetName"></span><br>
                    <strong>Количество карточек:</strong> <span id="previewCardCount"></span><br>
                    <strong>Первые слова:</strong> <span id="previewFirstWords"></span>
                </div>
            </div>
            <div class="form-group" id="importNameSection" style="display: none;">
                <label for="importSetName">Название для импортируемого набора</label>
                <input type="text" id="importSetName" class="form-control" placeholder="Введите название набора">
                <div class="warning-message" id="importNameWarning" style="display: none;">Пожалуйста, введите название набора</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelImport">Отмена</button>
                <button class="btn btn-primary" id="confirmImport" disabled>Импорт</button>
            </div>
        </div>
    </div>

    <script>
        // Данные приложения
        let sets = JSON.parse(localStorage.getItem('thinkSmileSets')) || [];
        let currentSetId = null;
        let currentMode = 'cards'; // 'cards', 'study' или 'stats'
        let currentViewMode = 'cards'; // 'cards' или 'list'
        let currentQuestionIndex = 0;
        let studyQuestions = [];
        let currentStudyType = 'mixed';
        let editingCardId = null;
        let editingSetId = null;
        let speechSynthesis = window.speechSynthesis;
        let isDarkTheme = localStorage.getItem('thinkSmileDarkTheme') === 'true';
        let deleteSetId = null;
        let importSetData = null;

        // Переменные для поиска и фильтрации
        let currentSearchQuery = '';
        let currentFilter = 'all';

        // Переменные для экспорта/импорта
        let currentExportFormat = 'json';
        let currentImportFormat = 'json';

        // Алгоритм интервальных повторений
        const SRSStages = {
            0: { name: 'Новое', interval: 1, factor: 2.5 },
            1: { name: 'Изучается', interval: 1, factor: 2.5 },
            2: { name: 'Повторение', interval: 2, factor: 2.0 },
            3: { name: 'Закрепление', interval: 4, factor: 1.8 },
            4: { name: 'Усвоено', interval: 7, factor: 1.5 }
        };

        // Готовые наборы слов
        const predefinedSets = [
            {
                id: 'predefined_top100',
                name: 'Топ-100 английских слов',
                predefined: true,
                cards: [
                    { term: 'the', definition: 'определенный артикль', transcription: '[ðə]' },
                    { term: 'be', definition: 'быть', transcription: '[biː]' },
                    { term: 'to', definition: 'к, в', transcription: '[tuː]' },
                    { term: 'of', definition: 'из, от', transcription: '[ɒv]' },
                    { term: 'and', definition: 'и', transcription: '[ænd]' },
                    { term: 'a', definition: 'неопределенный артикль', transcription: '[ə]' },
                    { term: 'in', definition: 'в', transcription: '[ɪn]' },
                    { term: 'that', definition: 'тот, что', transcription: '[ðæt]' },
                    { term: 'have', definition: 'иметь', transcription: '[hæv]' },
                    { term: 'I', definition: 'я', transcription: '[aɪ]' },
                    { term: 'it', definition: 'оно, это', transcription: '[ɪt]' },
                    { term: 'for', definition: 'для', transcription: '[fɔːr]' },
                    { term: 'not', definition: 'не', transcription: '[nɒt]' },
                    { term: 'on', definition: 'на', transcription: '[ɒn]' },
                    { term: 'with', definition: 'с', transcription: '[wɪð]' },
                    { term: 'he', definition: 'он', transcription: '[hiː]' },
                    { term: 'as', definition: 'как, в качестве', transcription: '[æz]' },
                    { term: 'you', definition: 'ты, вы', transcription: '[juː]' },
                    { term: 'do', definition: 'делать', transcription: '[duː]' },
                    { term: 'at', definition: 'у, в', transcription: '[æt]' }
                ]
            },
            {
                id: 'predefined_food',
                name: 'Еда и напитки',
                predefined: true,
                cards: [
                    { term: 'apple', definition: 'яблоко', transcription: '[ˈæp.əl]' },
                    { term: 'banana', definition: 'банан', transcription: '[bəˈnɑː.nə]' },
                    { term: 'orange', definition: 'апельсин', transcription: '[ˈɒr.ɪndʒ]' },
                    { term: 'bread', definition: 'хлеб', transcription: '[bred]' },
                    { term: 'water', definition: 'вода', transcription: '[ˈwɔː.tər]' },
                    { term: 'coffee', definition: 'кофе', transcription: '[ˈkɒf.i]' },
                    { term: 'tea', definition: 'чай', transcription: '[tiː]' },
                    { term: 'milk', definition: 'молоко', transcription: '[mɪlk]' },
                    { term: 'meat', definition: 'мясо', transcription: '[miːt]' },
                    { term: 'fish', definition: 'рыба', transcription: '[fɪʃ]' },
                    { term: 'vegetables', definition: 'овощи', transcription: '[ˈvedʒ.tə.bəlz]' },
                    { term: 'fruit', definition: 'фрукты', transcription: '[fruːt]' },
                    { term: 'rice', definition: 'рис', transcription: '[raɪs]' },
                    { term: 'pasta', definition: 'паста', transcription: '[ˈpæs.tə]' },
                    { term: 'cheese', definition: 'сыр', transcription: '[tʃiːz]' }
                ]
            },
            {
                id: 'predefined_family',
                name: 'Семья и отношения',
                predefined: true,
                cards: [
                    { term: 'family', definition: 'семья', transcription: '[ˈfæm.əl.i]' },
                    { term: 'mother', definition: 'мать', transcription: '[ˈmʌð.ər]' },
                    { term: 'father', definition: 'отец', transcription: '[ˈfɑː.ðər]' },
                    { term: 'parents', definition: 'родители', transcription: '[ˈpeə.rənts]' },
                    { term: 'brother', definition: 'брат', transcription: '[ˈbrʌð.ər]' },
                    { term: 'sister', definition: 'сестра', transcription: '[ˈsɪs.tər]' },
                    { term: 'son', definition: 'сын', transcription: '[sʌn]' },
                    { term: 'daughter', definition: 'дочь', transcription: '[ˈdɔː.tər]' },
                    { term: 'children', definition: 'дети', transcription: '[ˈtʃɪl.drən]' },
                    { term: 'grandmother', definition: 'бабушка', transcription: '[ˈɡræn.mʌð.ər]' },
                    { term: 'grandfather', definition: 'дедушка', transcription: '[ˈɡræn.fɑː.ðər]' },
                    { term: 'friend', definition: 'друг', transcription: '[frend]' },
                    { term: 'husband', definition: 'муж', transcription: '[ˈhʌz.bənd]' },
                    { term: 'wife', definition: 'жена', transcription: '[waɪf]' }
                ]
            }
        ];

        // Элементы DOM
        const setsList = document.getElementById('setsList');
        const cardsContainer = document.getElementById('cardsContainer');
        const cardsList = document.getElementById('cardsList');
        const studyContainer = document.getElementById('studyContainer');
        const statsContainer = document.getElementById('statsContainer');
        const emptyState = document.getElementById('emptyState');
        const currentSetName = document.getElementById('currentSetName');
        const createSetBtn = document.getElementById('createSetBtn');
        const createSetModal = document.getElementById('createSetModal');
        const closeCreateSetModal = document.getElementById('closeCreateSetModal');
        const cancelCreateSet = document.getElementById('cancelCreateSet');
        const saveSet = document.getElementById('saveSet');
        const setNameInput = document.getElementById('setName');
        const setNameWarning = document.getElementById('setNameWarning');
        const createCardModal = document.getElementById('createCardModal');
        const cardModalTitle = document.getElementById('cardModalTitle');
        const closeCreateCardModal = document.getElementById('closeCreateCardModal');
        const cancelCreateCard = document.getElementById('cancelCreateCard');
        const saveCard = document.getElementById('saveCard');
        const cardTermInput = document.getElementById('cardTerm');
        const cardTermWarning = document.getElementById('cardTermWarning');
        const cardDefinitionInput = document.getElementById('cardDefinition');
        const cardDefinitionWarning = document.getElementById('cardDefinitionWarning');
        const editSetModal = document.getElementById('editSetModal');
        const editSetName = document.getElementById('editSetName');
        const editSetNameWarning = document.getElementById('editSetNameWarning');
        const closeEditSetModal = document.getElementById('closeEditSetModal');
        const cancelEditSet = document.getElementById('cancelEditSet');
        const saveEditSet = document.getElementById('saveEditSet');
        const cardsModeBtn = document.getElementById('cardsModeBtn');
        const studyModeBtn = document.getElementById('studyModeBtn');
        const statsModeBtn = document.getElementById('statsModeBtn');
        const viewModeSelector = document.getElementById('viewModeSelector');
        const viewModeButtons = document.querySelectorAll('.view-mode-btn');
        const studyQuestion = document.getElementById('studyQuestion');
        const studyOptions = document.getElementById('studyOptions');
        const studyProgress = document.getElementById('studyProgress');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const studyTypeButtons = document.querySelectorAll('.study-type-btn');
        const typingInputContainer = document.getElementById('typingInputContainer');
        const typingAnswer = document.getElementById('typingAnswer');
        const checkTypingAnswer = document.getElementById('checkTypingAnswer');
        const audioContainer = document.getElementById('audioContainer');
        const playAudioBtn = document.getElementById('playAudioBtn');
        const audioOptions = document.getElementById('audioOptions');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const deleteModalTitle = document.getElementById('deleteModalTitle');
        const deleteModalMessage = document.getElementById('deleteModalMessage');
        const closeConfirmDeleteModal = document.getElementById('closeConfirmDeleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        const themeSwitcher = document.getElementById('themeSwitcher');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const exportModal = document.getElementById('exportModal');
        const closeExportModal = document.getElementById('closeExportModal');
        const cancelExport = document.getElementById('cancelExport');
        const downloadExport = document.getElementById('downloadExport');
        const exportContent = document.getElementById('exportContent');
        const exportFormatButtons = document.querySelectorAll('.export-format-btn');
        const importModal = document.getElementById('importModal');
        const importFileInput = document.getElementById('importFileInput');
        const importFileWarning = document.getElementById('importFileWarning');
        const importPreview = document.getElementById('importPreview');
        const previewSetName = document.getElementById('previewSetName');
        const previewCardCount = document.getElementById('previewCardCount');
        const previewFirstWords = document.getElementById('previewFirstWords');
        const importNameSection = document.getElementById('importNameSection');
        const importSetName = document.getElementById('importSetName');
        const importNameWarning = document.getElementById('importNameWarning');
        const closeImportModal = document.getElementById('closeImportModal');
        const cancelImport = document.getElementById('cancelImport');
        const confirmImport = document.getElementById('confirmImport');
        const importFormatButtons = document.querySelectorAll('.import-format-btn');
        const totalCards = document.getElementById('totalCards');
        const learnedCards = document.getElementById('learnedCards');
        const difficultCards = document.getElementById('difficultCards');
        const successRate = document.getElementById('successRate');
        const learnedProgress = document.getElementById('learnedProgress');
        const dueCards = document.getElementById('dueCards');
        const masteredCards = document.getElementById('masteredCards');
        const difficultWordsSection = document.getElementById('difficultWordsSection');
        const difficultWordsList = document.getElementById('difficultWordsList');
        const addPredefinedSetBtn = document.getElementById('addPredefinedSetBtn');
        const srsRatingButtons = document.getElementById('srsRatingButtons');
        const srsRatingBtns = document.querySelectorAll('.srs-rating-btn');

        // Элементы поиска и фильтрации
        const searchFilterContainer = document.getElementById('searchFilterContainer');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const searchResultsInfo = document.getElementById('searchResultsInfo');

        // Инициализация приложения
        function init() {
            applyTheme();
            renderSets();
            setupEventListeners();
            initPWA();
            
            // Если есть наборы, выбираем первый
            if (sets.length > 0) {
                selectSet(sets[0].id);
            } else {
                showEmptyState();
            }
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            createSetBtn.addEventListener('click', () => {
                createSetModal.classList.add('active');
                setNameInput.focus();
            });
            
            closeCreateSetModal.addEventListener('click', closeCreateSetModalFunc);
            cancelCreateSet.addEventListener('click', closeCreateSetModalFunc);
            
            saveSet.addEventListener('click', () => {
                const name = setNameInput.value.trim();
                if (name) {
                    setNameWarning.style.display = 'none';
                    createSet(name);
                    closeCreateSetModalFunc();
                } else {
                    setNameWarning.style.display = 'block';
                }
            });
            
            closeCreateCardModal.addEventListener('click', closeCreateCardModalFunc);
            cancelCreateCard.addEventListener('click', closeCreateCardModalFunc);
            
            saveCard.addEventListener('click', () => {
                const term = cardTermInput.value.trim();
                const definition = cardDefinitionInput.value.trim();
                
                // Проверяем, выбран ли набор
                if (!currentSetId) {
                    showNotification('Пожалуйста, сначала выберите или создайте набор', 'error');
                    closeCreateCardModalFunc();
                    return;
                }
                
                // Проверяем заполнение полей
                let hasError = false;
                
                if (!term) {
                    cardTermWarning.style.display = 'block';
                    hasError = true;
                } else {
                    cardTermWarning.style.display = 'none';
                }
                
                if (!definition) {
                    cardDefinitionWarning.style.display = 'block';
                    hasError = true;
                } else {
                    cardDefinitionWarning.style.display = 'none';
                }
                
                if (!hasError) {
                    if (editingCardId) {
                        updateCard(currentSetId, editingCardId, term, definition);
                    } else {
                        createCard(currentSetId, term, definition);
                    }
                    closeCreateCardModalFunc();
                }
            });
            
            // Редактирование набора
            closeEditSetModal.addEventListener('click', closeEditSetModalFunc);
            cancelEditSet.addEventListener('click', closeEditSetModalFunc);
            saveEditSet.addEventListener('click', () => {
                const name = editSetName.value.trim();
                if (name) {
                    editSetNameWarning.style.display = 'none';
                    updateSet(editingSetId, name);
                    closeEditSetModalFunc();
                } else {
                    editSetNameWarning.style.display = 'block';
                }
            });
            
            cardsModeBtn.addEventListener('click', () => switchMode('cards'));
            studyModeBtn.addEventListener('click', () => switchMode('study'));
            statsModeBtn.addEventListener('click', () => switchMode('stats'));
            
            // Обработчики для режима просмотра
            viewModeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    viewModeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentViewMode = btn.dataset.view;
                    renderCards();
                });
            });
            
            prevQuestionBtn.addEventListener('click', showPreviousQuestion);
            nextQuestionBtn.addEventListener('click', showNextQuestion);
            
            // Обработчики для типов обучения
            studyTypeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    studyTypeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStudyType = btn.dataset.type;
                    if (currentSetId) {
                        startStudySession();
                    }
                });
            });
            
            checkTypingAnswer.addEventListener('click', checkTypingAnswerFunc);
            typingAnswer.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkTypingAnswerFunc();
                }
            });
            
            playAudioBtn.addEventListener('click', playAudioWord);
            
            // Обработчики для модального окна удаления
            closeConfirmDeleteModal.addEventListener('click', closeConfirmDeleteModalFunc);
            cancelDelete.addEventListener('click', closeConfirmDeleteModalFunc);
            confirmDelete.addEventListener('click', confirmDeleteFunc);
            
            // Переключение темы
            themeSwitcher.addEventListener('click', toggleTheme);
            
            // Экспорт/импорт
            exportBtn.addEventListener('click', showExportModal);
            importBtn.addEventListener('click', showImportModal);
            
            // Экспорт
            closeExportModal.addEventListener('click', closeExportModalFunc);
            cancelExport.addEventListener('click', closeExportModalFunc);
            downloadExport.addEventListener('click', downloadExportFile);
            
            // Импорт
            importFileInput.addEventListener('change', handleFileImport);
            importSetName.addEventListener('input', validateImportName);
            closeImportModal.addEventListener('click', closeImportModalFunc);
            cancelImport.addEventListener('click', closeImportModalFunc);
            confirmImport.addEventListener('click', confirmImportFunc);
            
            // Кнопки форматов
            exportFormatButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    exportFormatButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentExportFormat = btn.dataset.format;
                    updateExportContent();
                });
            });
            
            importFormatButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    importFormatButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentImportFormat = btn.dataset.format;
                    importFileInput.accept = currentImportFormat === 'json' ? '.json' : '.txt';
                    importFileInput.value = ''; // Сбрасываем выбранный файл
                    importPreview.style.display = 'none';
                    importNameSection.style.display = 'none';
                    confirmImport.disabled = true;
                });
            });
            
            // Поиск и фильтрация
            searchInput.addEventListener('input', handleSearch);
            clearSearchBtn.addEventListener('click', clearSearch);
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderCards();
                });
            });

            // Готовые наборы
            addPredefinedSetBtn.addEventListener('click', showPredefinedSetsModal);

            // SRS кнопки рейтинга
            srsRatingBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    handleSRSRating(this.dataset.rating);
                });
            });
            
            // Закрытие модальных окон при клике вне их
            window.addEventListener('click', (e) => {
                if (e.target === createSetModal) {
                    closeCreateSetModalFunc();
                }
                if (e.target === createCardModal) {
                    closeCreateCardModalFunc();
                }
                if (e.target === editSetModal) {
                    closeEditSetModalFunc();
                }
                if (e.target === confirmDeleteModal) {
                    closeConfirmDeleteModalFunc();
                }
                if (e.target === exportModal) {
                    closeExportModalFunc();
                }
                if (e.target === importModal) {
                    closeImportModalFunc();
                }
            });
            
            // Обработка нажатия Enter в модальных окнах
            setNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveSet.click();
                }
            });
            
            cardTermInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    cardDefinitionInput.focus();
                }
            });
            
            cardDefinitionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveCard.click();
                }
            });
        }

        // PWA функциональность
        function initPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed');
                    });
            }

            // Обработчик установки PWA
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallPrompt();
            });

            function showInstallPrompt() {
                if (deferredPrompt && !document.getElementById('installPWAButton')) {
                    const installBtn = document.createElement('button');
                    installBtn.id = 'installPWAButton';
                    installBtn.textContent = '📱 Установить';
                    installBtn.className = 'btn btn-success';
                    installBtn.style.marginLeft = '10px';
                    installBtn.onclick = installPWA;
                    
                    const headerActions = document.querySelector('.header-actions');
                    headerActions.appendChild(installBtn);
                }
            }

            function installPWA() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showNotification('Приложение успешно установлено!', 'success');
                            document.getElementById('installPWAButton').remove();
                        }
                        deferredPrompt = null;
                    });
                }
            }
        }

        // Функции для работы с темами
        function applyTheme() {
            if (isDarkTheme) {
                document.body.setAttribute('data-theme', 'dark');
                themeSwitcher.textContent = '☀️';
            } else {
                document.body.removeAttribute('data-theme');
                themeSwitcher.textContent = '🌙';
            }
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            localStorage.setItem('thinkSmileDarkTheme', isDarkTheme);
            applyTheme();
        }

        // Функции для работы с наборами
        function createSet(name) {
            const newSet = {
                id: Date.now().toString(),
                name: name,
                cards: [],
                stats: {
                    totalStudied: 0,
                    correctAnswers: 0,
                    difficultWords: []
                }
            };
            
            sets.push(newSet);
            saveData();
            renderSets();
            selectSet(newSet.id);
            
            // Показываем сообщение об успешном создании
            showNotification(`Набор "${name}" успешно создан!`, 'success');
        }

        function updateSet(setId, name) {
            const set = sets.find(s => s.id === setId);
            if (set) {
                set.name = name;
                saveData();
                renderSets();
                if (currentSetId === setId) {
                    currentSetName.textContent = name;
                }
                showNotification(`Набор переименован в "${name}"!`, 'success');
            }
        }

        function deleteSet(setId) {
            sets = sets.filter(set => set.id !== setId);
            saveData();
            renderSets();
            
            if (sets.length > 0) {
                selectSet(sets[0].id);
            } else {
                currentSetId = null;
                currentSetName.textContent = 'Выберите набор';
                showEmptyState();
            }
            
            showNotification('Набор удален', 'info');
            closeConfirmDeleteModalFunc(); // Закрываем попап после удаления
        }

        function selectSet(setId) {
            currentSetId = setId;
            
            // Обновляем активный элемент в списке
            document.querySelectorAll('.set-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === setId) {
                    item.classList.add('active');
                }
            });
            
            // Обновляем отображаемое имя набора
            const set = sets.find(s => s.id === setId);
            if (set) {
                currentSetName.textContent = set.name;
                renderCards();
                updateStudyQuestions();
                updateStats();
                
                // Показываем/скрываем переключатель режима просмотра
                if (set.cards.length > 0) {
                    viewModeSelector.style.display = 'flex';
                } else {
                    viewModeSelector.style.display = 'none';
                }
                
                if (set.cards.length === 0) {
                    showEmptyState();
                } else {
                    hideEmptyState();
                }
            }
        }

        function renderSets() {
            setsList.innerHTML = '';
            
            if (sets.length === 0) {
                setsList.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 20px;">Нет наборов</p>';
                return;
            }
            
            sets.forEach(set => {
                const setItem = document.createElement('div');
                setItem.className = 'set-item';
                setItem.dataset.id = set.id;
                setItem.innerHTML = `
                    <div class="set-icon">${set.name.charAt(0).toUpperCase()}</div>
                    <span>${set.name}</span>
                    <span style="margin-left: auto; font-size: 12px; color: var(--gray); margin-right: 10px;">${set.cards.length}</span>
                    <div class="set-actions">
                        <button class="action-btn edit-set-btn" title="Редактировать набор">✏️</button>
                        <button class="action-btn delete-btn" title="Удалить набор">🗑️</button>
                    </div>
                `;
                
                setItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.set-actions')) {
                        selectSet(set.id);
                    }
                });
                
                const editBtn = setItem.querySelector('.edit-set-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showEditSetModal(set.id, set.name);
                });
                
                const deleteBtn = setItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteSetModal(set.id, set.name);
                });
                
                setsList.appendChild(setItem);
            });
        }

        function showEditSetModal(setId, setName) {
            editingSetId = setId;
            editSetName.value = setName;
            editSetNameWarning.style.display = 'none';
            editSetModal.classList.add('active');
            editSetName.focus();
        }

        // Функции для работы с карточками
        function createCard(setId, term, definition) {
            const set = sets.find(s => s.id === setId);
            if (set) {
                set.cards.push({
                    id: Date.now().toString(),
                    term: term,
                    definition: definition,
                    transcription: getTranscription(term),
                    stats: {
                        studied: 0,
                        correct: 0,
                        difficulty: 0 // 0-легкое, 1-среднее, 2-сложное
                    },
                    userDifficulty: 'easy', // easy, medium, hard
                    srs: {
                        stage: 0,
                        interval: 1,
                        dueDate: new Date(),
                        easeFactor: 2.5,
                        reviews: 0
                    }
                });
                
                saveData();
                renderCards();
                updateStudyQuestions();
                updateStats();
                hideEmptyState();
                
                // Показываем сообщение об успешном создании
                showNotification(`Карточка "${term}" добавлена!`, 'success');
            }
        }

        function updateCard(setId, cardId, term, definition) {
            const set = sets.find(s => s.id === setId);
            if (set) {
                const card = set.cards.find(c => c.id === cardId);
                if (card) {
                    card.term = term;
                    card.definition = definition;
                    card.transcription = getTranscription(term);
                    
                    saveData();
                    renderCards();
                    updateStudyQuestions();
                    updateStats();
                    
                    // Показываем сообщение об успешном обновлении
                    showNotification(`Карточка "${term}" обновлена!`, 'success');
                }
            }
        }

        function updateCardDifficulty(setId, cardId, difficulty) {
            const set = sets.find(s => s.id === setId);
            if (set) {
                const card = set.cards.find(c => c.id === cardId);
                if (card) {
                    card.userDifficulty = difficulty;
                    saveData();
                    renderCards();
                    showNotification(`Сложность карточки "${card.term}" изменена на "${getDifficultyLabel(difficulty)}"`, 'info');
                }
            }
        }

        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'Легкое',
                'medium': 'Среднее', 
                'hard': 'Сложное'
            };
            return labels[difficulty] || 'Легкое';
        }

        function deleteCard(setId, cardId) {
            const set = sets.find(s => s.id === setId);
            if (set) {
                const cardIndex = set.cards.findIndex(c => c.id === cardId);
                if (cardIndex !== -1) {
                    const cardTerm = set.cards[cardIndex].term;
                    set.cards.splice(cardIndex, 1);
                    
                    saveData();
                    renderCards();
                    updateStudyQuestions();
                    updateStats();
                    
                    if (set.cards.length === 0) {
                        showEmptyState();
                    }
                    
                    // Показываем сообщение об удалении
                    showNotification(`Карточка "${cardTerm}" удалена`, 'info');
                }
            }
        }

        function updateCardStats(setId, cardId, isCorrect) {
            const set = sets.find(s => s.id === setId);
            if (set) {
                const card = set.cards.find(c => c.id === cardId);
                if (card) {
                    card.stats.studied++;
                    if (isCorrect) {
                        card.stats.correct++;
                    }
                    
                    // Обновляем сложность слова
                    const successRate = card.stats.correct / card.stats.studied;
                    if (successRate < 0.5) {
                        card.stats.difficulty = 2; // Сложное
                    } else if (successRate < 0.8) {
                        card.stats.difficulty = 1; // Среднее
                    } else {
                        card.stats.difficulty = 0; // Легкое
                    }
                    
                    // Обновляем статистику набора
                    set.stats.totalStudied++;
                    if (isCorrect) {
                        set.stats.correctAnswers++;
                    }
                    
                    saveData();
                    updateStats();
                }
            }
        }

        // SRS функции
        function updateCardSRS(cardId, rating) {
            const set = sets.find(s => s.id === currentSetId);
            if (!set) return;
            
            const card = set.cards.find(c => c.id === cardId);
            if (!card) return;
            
            // Инициализируем SRS данные если их нет
            if (!card.srs) {
                card.srs = {
                    stage: 0,
                    interval: 1, // в днях
                    dueDate: new Date(),
                    easeFactor: 2.5,
                    reviews: 0
                };
            }
            
            const srs = card.srs;
            srs.reviews++;
            
            // Обновляем сложность на основе ответа
            if (rating === 'again') {
                srs.stage = Math.max(0, srs.stage - 1);
                srs.easeFactor = Math.max(1.3, srs.easeFactor - 0.2);
            } else if (rating === 'hard') {
                srs.easeFactor = Math.max(1.3, srs.easeFactor - 0.15);
            } else if (rating === 'good') {
                srs.stage = Math.min(4, srs.stage + 1);
            } else if (rating === 'easy') {
                srs.stage = Math.min(4, srs.stage + 2);
                srs.easeFactor = Math.min(2.5, srs.easeFactor + 0.1);
            }
            
            // Вычисляем новый интервал
            if (srs.stage === 0) {
                srs.interval = 1;
            } else if (srs.stage === 1) {
                srs.interval = 1;
            } else {
                srs.interval = Math.round(srs.interval * srs.easeFactor);
            }
            
            // Устанавливаем дату следующего повторения
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + srs.interval);
            srs.dueDate = nextDate;
            
            saveData();
        }

        function getDueCards() {
            if (!currentSetId) return [];
            
            const set = sets.find(s => s.id === currentSetId);
            if (!set) return [];
            
            const now = new Date();
            return set.cards.filter(card => {
                if (!card.srs) return true; // Новые карточки
                return new Date(card.srs.dueDate) <= now;
            });
        }

        function getStudyPriority() {
            const dueCards = getDueCards();
            return dueCards.sort((a, b) => {
                const aDue = a.srs ? new Date(a.srs.dueDate) : new Date(0);
                const bDue = b.srs ? new Date(b.srs.dueDate) : new Date(0);
                return aDue - bDue;
            });
        }

        function handleSRSRating(rating) {
            const currentQuestion = studyQuestions[currentQuestionIndex];
            if (currentQuestion && currentQuestion.cardId) {
                updateCardSRS(currentQuestion.cardId, rating);
                showNotification(`Рейтинг "${getRatingLabel(rating)}" сохранен`, 'info');
                
                // Переходим к следующему вопросу
                if (currentQuestionIndex < studyQuestions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    switchMode('cards');
                    showNotification('Сессия интервального повторения завершена! 🎊', 'success');
                }
            }
        }

        function getRatingLabel(rating) {
            const labels = {
                'again': 'Снова',
                'hard': 'Трудно',
                'good': 'Хорошо',
                'easy': 'Легко'
            };
            return labels[rating] || rating;
        }

        function renderCards() {
            cardsContainer.innerHTML = '';
            cardsList.innerHTML = '';
            
            if (!currentSetId) {
                cardsContainer.innerHTML = '<div class="empty-state"><i>📚</i><h3>Выберите набор</h3><p>Создайте или выберите набор для работы с карточками</p></div>';
                return;
            }
            
            const set = sets.find(s => s.id === currentSetId);
            if (!set) return;
            
            // Показываем/скрываем поиск в зависимости от наличия карточек
            if (set.cards.length > 0) {
                searchFilterContainer.style.display = 'block';
            } else {
                searchFilterContainer.style.display = 'none';
            }
            
            let filteredCards = set.cards;
            let visibleCount = 0;
            
            // Применяем поиск
            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                filteredCards = filteredCards.filter(card => 
                    card.term.toLowerCase().includes(query) || 
                    card.definition.toLowerCase().includes(query)
                );
            }
            
            // Применяем фильтр по сложности
            if (currentFilter !== 'all') {
                filteredCards = filteredCards.filter(card => card.userDifficulty === currentFilter);
            }
            
            // Отображаем карточки в выбранном режиме
            if (currentViewMode === 'cards') {
                cardsContainer.style.display = 'grid';
                cardsList.style.display = 'none';
                renderCardsView(filteredCards);
            } else {
                cardsContainer.style.display = 'none';
                cardsList.style.display = 'flex';
                renderListView(filteredCards);
            }
            
            // Обновляем информацию о результатах поиска
            searchResultsInfo.textContent = `Найдено карточек: ${filteredCards.length} из ${set.cards.length}`;
            
            // Если после фильтрации нет карточек, показываем сообщение
            if (filteredCards.length === 0) {
                const noResultsElement = document.createElement('div');
                noResultsElement.className = 'empty-state';
                noResultsElement.innerHTML = `
                    <i>🔍</i>
                    <h3>Ничего не найдено</h3>
                    <p>Попробуйте изменить поисковый запрос или фильтр</p>
                `;
                if (currentViewMode === 'cards') {
                    cardsContainer.appendChild(noResultsElement);
                } else {
                    cardsList.appendChild(noResultsElement);
                }
            }
            
            // Добавляем кнопку для создания новой карточки
            const addCardBtn = document.createElement('div');
            addCardBtn.className = 'add-card-btn';
            addCardBtn.innerHTML = `
                <i>+</i>
                <span>Добавить карточку</span>
            `;
            addCardBtn.addEventListener('click', () => {
                // Проверяем, выбран ли набор
                if (!currentSetId) {
                    showNotification('Пожалуйста, сначала выберите или создайте набор', 'error');
                    return;
                }
                
                cardTermInput.value = '';
                cardDefinitionInput.value = '';
                cardTermWarning.style.display = 'none';
                cardDefinitionWarning.style.display = 'none';
                cardModalTitle.textContent = 'Добавить карточку';
                editingCardId = null;
                createCardModal.classList.add('active');
                cardTermInput.focus();
            });
            
            if (currentViewMode === 'cards') {
                cardsContainer.appendChild(addCardBtn);
            } else {
                cardsList.appendChild(addCardBtn);
            }
            
            visibleCount = filteredCards.length;
        }

        // Функция для отображения карточек
        function renderCardsView(cards) {
            cards.forEach(card => {
                const difficultyLabels = ['', '🟡 Среднее', '🔴 Сложное'];
                const srsStageLabels = ['🆕', '📚', '🔄', '✅', '🎯'];
                
                const cardElement = document.createElement('div');
                cardElement.className = `card ${card.userDifficulty}`;
                cardElement.innerHTML = `
                    <div class="card-header">
                        <div class="card-header-left">
                            ${card.stats.difficulty > 0 ? `<div class="card-difficulty">${difficultyLabels[card.stats.difficulty]}</div>` : ''}
                            ${card.srs && card.srs.stage > 0 ? `<div class="srs-stage">${srsStageLabels[card.srs.stage]} ${SRSStages[card.srs.stage].name}</div>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="action-btn edit-card-btn" title="Редактировать">✏️</button>
                            <button class="action-btn delete-card-btn" title="Удалить">🗑️</button>
                        </div>
                    </div>
                    <div class="card-term">
                        ${card.term}
                        <button class="card-audio-btn" title="Прослушать произношение">🔊</button>
                    </div>
                    ${card.transcription ? `<div class="transcription">${card.transcription}</div>` : ''}
                    <div class="card-definition">${card.definition}</div>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn easy ${card.userDifficulty === 'easy' ? 'active' : ''}" data-difficulty="easy">Легкое</button>
                        <button class="difficulty-btn medium ${card.userDifficulty === 'medium' ? 'active' : ''}" data-difficulty="medium">Среднее</button>
                        <button class="difficulty-btn hard ${card.userDifficulty === 'hard' ? 'active' : ''}" data-difficulty="hard">Сложное</button>
                    </div>
                    ${card.stats.studied > 0 ? `
                        <div style="margin-top: 10px; font-size: 12px; color: var(--gray);">
                            Изучено: ${card.stats.studied} раз, Успешно: ${Math.round((card.stats.correct / card.stats.studied) * 100)}%
                        </div>
                    ` : ''}
                    ${card.srs ? `
                        <div style="margin-top: 5px; font-size: 11px; color: var(--gray);">
                            SRS: ${card.srs.reviews} повт., след. повтор: ${new Date(card.srs.dueDate).toLocaleDateString()}
                        </div>
                    ` : ''}
                `;
                
                const editBtn = cardElement.querySelector('.edit-card-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editCard(card.id);
                });
                
                const deleteBtn = cardElement.querySelector('.delete-card-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCard(currentSetId, card.id);
                });
                
                const audioBtn = cardElement.querySelector('.card-audio-btn');
                audioBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playWordAudio(card.term);
                });
                
                // Обработчики для кнопок сложности
                const difficultyBtns = cardElement.querySelectorAll('.difficulty-btn');
                difficultyBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateCardDifficulty(currentSetId, card.id, btn.dataset.difficulty);
                    });
                });
                
                cardsContainer.appendChild(cardElement);
            });
        }

        // Функция для отображения списка
        function renderListView(cards) {
            cards.forEach(card => {
                const listItem = document.createElement('div');
                listItem.className = `list-item ${card.userDifficulty}`;
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-term">${card.term}</div>
                        ${card.transcription ? `<div class="list-transcription">${card.transcription}</div>` : '<div class="list-transcription"></div>'}
                        <div class="list-definition">${card.definition}</div>
                    </div>
                    <div class="list-actions">
                        <button class="audio-btn-small" title="Прослушать произношение">🔊</button>
                        <button class="action-btn edit-card-btn" title="Редактировать">✏️</button>
                        <button class="action-btn delete-card-btn" title="Удалить">🗑️</button>
                    </div>
                `;
                
                const editBtn = listItem.querySelector('.edit-card-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editCard(card.id);
                });
                
                const deleteBtn = listItem.querySelector('.delete-card-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCard(currentSetId, card.id);
                });
                
                const audioBtn = listItem.querySelector('.audio-btn-small');
                audioBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playWordAudio(card.term);
                });
                
                cardsList.appendChild(listItem);
            });
        }

        // Функции поиска и фильтрации
        function handleSearch() {
            currentSearchQuery = searchInput.value.trim();
            renderCards();
        }

        function clearSearch() {
            searchInput.value = '';
            currentSearchQuery = '';
            renderCards();
        }

        function editCard(cardId) {
            const set = sets.find(s => s.id === currentSetId);
            if (set) {
                const card = set.cards.find(c => c.id === cardId);
                if (card) {
                    cardTermInput.value = card.term;
                    cardDefinitionInput.value = card.definition;
                    cardTermWarning.style.display = 'none';
                    cardDefinitionWarning.style.display = 'none';
                    cardModalTitle.textContent = 'Редактировать карточку';
                    editingCardId = cardId;
                    createCardModal.classList.add('active');
                    cardTermInput.focus();
                }
            }
        }

        // Функция для получения транскрипции
        function getTranscription(word) {
            // Простая имитация транскрипции - в реальном приложении можно использовать API
            const transcriptionMap = {
                'apple': '[ˈæp.əl]',
                'banana': '[bəˈnɑː.nə]',
                'orange': '[ˈɒr.ɪndʒ]',
                'hello': '[həˈləʊ]',
                'goodbye': '[ɡʊdˈbaɪ]',
                'thank you': '[ˈθæŋk juː]',
                'please': '[pliːz]',
                'sorry': '[ˈsɒr.i]',
                'water': '[ˈwɔː.tər]',
                'food': '[fuːd]',
                'house': '[haʊs]',
                'car': '[kɑːr]',
                'book': '[bʊk]',
                'pen': '[pen]',
                'computer': '[kəmˈpjuː.tər]',
                'phone': '[fəʊn]',
                'friend': '[frend]',
                'family': '[ˈfæm.əl.i]',
                'school': '[skuːl]',
                'work': '[wɜːk]',
                'time': '[taɪm]',
                'day': '[deɪ]',
                'night': '[naɪt]',
                'week': '[wiːk]',
                'month': '[mʌnθ]',
                'year': '[jɪər]',
                'people': '[ˈpiː.pəl]',
                'man': '[mæn]',
                'woman': '[ˈwʊm.ən]',
                'child': '[tʃaɪld]',
                'city': '[ˈsɪt.i]',
                'country': '[ˈkʌn.tri]',
                'world': '[wɜːld]',
                'life': '[laɪf]',
                'love': '[lʌv]',
                'happy': '[ˈhæp.i]',
                'sad': '[sæd]',
                'good': '[ɡʊd]',
                'bad': '[bæd]',
                'big': '[bɪɡ]',
                'small': '[smɔːl]',
                'hot': '[hɒt]',
                'cold': '[kəʊld]',
                'new': '[njuː]',
                'old': '[əʊld]',
                'young': '[jʌŋ]',
                'beautiful': '[ˈbjuː.tɪ.fəl]',
                'ugly': '[ˈʌɡ.li]',
                'rich': '[rɪtʃ]',
                'poor': '[pɔːr]',
                'fast': '[fɑːst]',
                'slow': '[sləʊ]',
                'easy': '[ˈiː.zi]',
                'difficult': '[ˈdɪf.ɪ.kəlt]',
                'important': '[ɪmˈpɔː.tənt]',
                'interesting': '[ˈɪn.trəs.tɪŋ]',
                'boring': '[ˈbɔː.rɪŋ]',
                'funny': '[ˈfʌn.i]',
                'serious': '[ˈsɪə.ri.əs]'
            };
            
            return transcriptionMap[word.toLowerCase()] || '';
        }

        // Функция для воспроизведения аудио слова
        function playWordAudio(word) {
            if (word && speechSynthesis) {
                // Останавливаем предыдущее воспроизведение
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Пытаемся найти британский акцент
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(voice => 
                    voice.lang.includes('en') && voice.name.includes('British')
                ) || voices.find(voice => 
                    voice.lang.includes('en')
                );
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        // Функции для режима заучивания
        function switchMode(mode) {
            // Проверяем, есть ли карточки для изучения
            if ((mode === 'study' || mode === 'stats') && currentSetId) {
                const set = sets.find(s => s.id === currentSetId);
                if (!set || set.cards.length === 0) {
                    showNotification('Добавьте карточки в набор для использования этого режима', 'error');
                    return;
                }
            }
            
            currentMode = mode;
            
            // Скрываем все контейнеры
            cardsContainer.style.display = 'none';
            cardsList.style.display = 'none';
            studyContainer.classList.remove('active');
            statsContainer.style.display = 'none';
            searchFilterContainer.style.display = 'none';
            viewModeSelector.style.display = 'none';
            srsRatingButtons.style.display = 'none';
            
            // Обновляем активные кнопки
            cardsModeBtn.classList.remove('active');
            studyModeBtn.classList.remove('active');
            statsModeBtn.classList.remove('active');
            
            if (mode === 'cards') {
                cardsModeBtn.classList.add('active');
                // Показываем переключатель режима просмотра только если есть карточки
                const set = sets.find(s => s.id === currentSetId);
                if (set && set.cards.length > 0) {
                    viewModeSelector.style.display = 'flex';
                    searchFilterContainer.style.display = 'block';
                }
                renderCards();
            } else if (mode === 'study') {
                studyModeBtn.classList.add('active');
                studyContainer.classList.add('active');
                
                if (currentSetId) {
                    startStudySession();
                }
            } else if (mode === 'stats') {
                statsModeBtn.classList.add('active');
                statsContainer.style.display = 'block';
                updateStats();
            }
        }

        function updateStudyQuestions() {
            if (!currentSetId) return;
            
            const set = sets.find(s => s.id === currentSetId);
            if (!set) return;
            
            studyQuestions = [];
            
            // Создаем вопросы в зависимости от типа обучения
            if (currentStudyType === 'mixed') {
                // Смешанный режим - все типы вопросов
                set.cards.forEach(card => {
                    // Английский → русский
                    studyQuestions.push({
                        type: 'en-ru',
                        question: `Как переводится слово "${card.term}"?`,
                        correctAnswer: card.definition,
                        options: generateOptions(card.definition, set.cards, 'definition'),
                        cardId: card.id
                    });
                    
                    // Русский → английский
                    studyQuestions.push({
                        type: 'ru-en',
                        question: `Как переводится слово "${card.definition}"?`,
                        correctAnswer: card.term,
                        options: generateOptions(card.term, set.cards, 'term'),
                        cardId: card.id
                    });
                    
                    // Печать (английский → русский)
                    studyQuestions.push({
                        type: 'typing-en-ru',
                        question: `Напишите перевод слова "${card.term}"`,
                        correctAnswer: card.definition.toLowerCase(),
                        cardId: card.id
                    });
                    
                    // Печать (русский → английский)
                    studyQuestions.push({
                        type: 'typing-ru-en',
                        question: `Напишите перевод слова "${card.definition}"`,
                        correctAnswer: card.term.toLowerCase(),
                        cardId: card.id
                    });
                    
                    // Аудио
                    studyQuestions.push({
                        type: 'audio',
                        question: `Прослушайте слово и выберите перевод`,
                        audioWord: card.term,
                        correctAnswer: card.definition,
                        options: generateOptions(card.definition, set.cards, 'definition'),
                        cardId: card.id
                    });
                });
            } else if (currentStudyType === 'en-ru') {
                // Только английский → русский
                set.cards.forEach(card => {
                    studyQuestions.push({
                        type: 'en-ru',
                        question: `Как переводится слово "${card.term}"?`,
                        correctAnswer: card.definition,
                        options: generateOptions(card.definition, set.cards, 'definition'),
                        cardId: card.id
                    });
                });
            } else if (currentStudyType === 'ru-en') {
                // Только русский → английский
                set.cards.forEach(card => {
                    studyQuestions.push({
                        type: 'ru-en',
                        question: `Как переводится слово "${card.definition}"?`,
                        correctAnswer: card.term,
                        options: generateOptions(card.term, set.cards, 'term'),
                        cardId: card.id
                    });
                });
            } else if (currentStudyType === 'typing') {
                // Ввод текста
                set.cards.forEach(card => {
                    studyQuestions.push({
                        type: 'typing-en-ru',
                        question: `Напишите перевод слова "${card.term}"`,
                        correctAnswer: card.definition.toLowerCase(),
                        cardId: card.id
                    });
                    
                    studyQuestions.push({
                        type: 'typing-ru-en',
                        question: `Напишите перевод слова "${card.definition}"`,
                        correctAnswer: card.term.toLowerCase(),
                        cardId: card.id
                    });
                });
            } else if (currentStudyType === 'audio') {
                // Аудио режим
                set.cards.forEach(card => {
                    studyQuestions.push({
                        type: 'audio',
                        question: `Прослушайте слово и выберите перевод`,
                        audioWord: card.term,
                        correctAnswer: card.definition,
                        options: generateOptions(card.definition, set.cards, 'definition'),
                        cardId: card.id
                    });
                });
            } else if (currentStudyType === 'difficult') {
                // Сложные слова
                const difficultCards = set.cards.filter(card => card.userDifficulty === 'hard' || card.stats.difficulty === 2);
                if (difficultCards.length === 0) {
                    showNotification('Нет сложных слов для повторения!', 'info');
                    return;
                }
                
                difficultCards.forEach(card => {
                    studyQuestions.push({
                        type: 'en-ru',
                        question: `Как переводится слово "${card.term}"?`,
                        correctAnswer: card.definition,
                        options: generateOptions(card.definition, set.cards, 'definition'),
                        cardId: card.id
                    });
                });
            } else if (currentStudyType === 'srs') {
                // Режим интервальных повторений
                const dueCards = getStudyPriority();
                if (dueCards.length === 0) {
                    showNotification('Поздравляем! Все слова изучены на сегодня 🎉', 'success');
                    return;
                }
                
                // Берем первые 20 карточек для повторения
                const cardsToStudy = dueCards.slice(0, 20);
                
                cardsToStudy.forEach(card => {
                    studyQuestions.push({
                        type: 'srs-en-ru',
                        question: `Как переводится слово "${card.term}"?`,
                        correctAnswer: card.definition,
                        options: generateOptions(card.definition, set.cards, 'definition'),
                        cardId: card.id
                    });
                    
                    studyQuestions.push({
                        type: 'srs-ru-en', 
                        question: `Как переводится слово "${card.definition}"?`,
                        correctAnswer: card.term,
                        options: generateOptions(card.term, set.cards, 'term'),
                        cardId: card.id
                    });
                });
            }
            
            // Перемешиваем вопросы
            studyQuestions = shuffleArray(studyQuestions);
        }

        function generateOptions(correctAnswer, cards, type) {
            const options = [correctAnswer];
            
            // Берем случайные определения/термины из других карточек
            while (options.length < 4 && options.length < cards.length) {
                const randomCard = cards[Math.floor(Math.random() * cards.length)];
                const randomOption = type === 'definition' ? randomCard.definition : randomCard.term;
                
                if (!options.includes(randomOption)) {
                    options.push(randomOption);
                }
            }
            
            // Если все еще недостаточно опций, добавляем пустые
            while (options.length < 4) {
                options.push(`Вариант ${options.length + 1}`);
            }
            
            return shuffleArray(options);
        }

        function startStudySession() {
            updateStudyQuestions();
            if (studyQuestions.length === 0) {
                showNotification('Нет вопросов для изучения в выбранном режиме', 'error');
                return;
            }
            currentQuestionIndex = 0;
            showQuestion();
        }

        function showQuestion() {
            if (studyQuestions.length === 0) {
                studyQuestion.textContent = "Нет вопросов для изучения";
                studyOptions.innerHTML = '';
                return;
            }
            
            const question = studyQuestions[currentQuestionIndex];
            studyQuestion.textContent = question.question;
            studyProgress.textContent = `Вопрос ${currentQuestionIndex + 1} из ${studyQuestions.length}`;
            
            // Обновляем кнопки навигации
            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            nextQuestionBtn.textContent = currentQuestionIndex === studyQuestions.length - 1 ? 'Завершить' : 'Далее';
            
            // Показываем соответствующий интерфейс в зависимости от типа вопроса
            studyOptions.style.display = 'none';
            typingInputContainer.style.display = 'none';
            audioContainer.style.display = 'none';
            srsRatingButtons.style.display = 'none';
            
            if (question.type.includes('typing')) {
                typingInputContainer.style.display = 'block';
                typingAnswer.value = '';
                typingAnswer.focus();
                typingAnswer.style.borderColor = 'var(--border-color)';
            } else if (question.type === 'audio') {
                audioContainer.style.display = 'block';
                // Автоматически проигрываем слово при показе вопроса
                setTimeout(() => playAudioWord(), 500);
                // Создаем варианты ответов для аудио режима
                audioOptions.innerHTML = '';
                question.options.forEach(option => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option';
                    optionBtn.textContent = option;
                    optionBtn.addEventListener('click', () => checkAnswer(optionBtn, option, question.correctAnswer, question.cardId));
                    audioOptions.appendChild(optionBtn);
                });
            } else if (question.type.includes('srs')) {
                // SRS режим - показываем варианты ответов и кнопки рейтинга
                studyOptions.style.display = 'grid';
                srsRatingButtons.style.display = 'flex';
                // Создаем варианты ответов
                studyOptions.innerHTML = '';
                question.options.forEach(option => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option';
                    optionBtn.textContent = option;
                    optionBtn.addEventListener('click', () => checkAnswer(optionBtn, option, question.correctAnswer, question.cardId));
                    studyOptions.appendChild(optionBtn);
                });
            } else {
                studyOptions.style.display = 'grid';
                // Создаем варианты ответов
                studyOptions.innerHTML = '';
                question.options.forEach(option => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option';
                    optionBtn.textContent = option;
                    optionBtn.addEventListener('click', () => checkAnswer(optionBtn, option, question.correctAnswer, question.cardId));
                    studyOptions.appendChild(optionBtn);
                });
            }
        }

        function checkAnswer(optionBtn, selectedAnswer, correctAnswer, cardId) {
            // Отключаем все кнопки
            document.querySelectorAll('.option').forEach(btn => {
                btn.disabled = true;
            });
            
            const isCorrect = selectedAnswer === correctAnswer;
            
            if (isCorrect) {
                optionBtn.classList.add('correct');
                showNotification('Правильно! 🎉', 'success');
            } else {
                optionBtn.classList.add('incorrect');
                
                // Подсвечиваем правильный ответ
                document.querySelectorAll('.option').forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
                
                showNotification(`Неправильно. Правильный ответ: ${correctAnswer}`, 'error');
            }
            
            // Обновляем статистику карточки
            if (cardId) {
                updateCardStats(currentSetId, cardId, isCorrect);
            }
        }

        function checkTypingAnswerFunc() {
            const userAnswer = typingAnswer.value.trim().toLowerCase();
            const correctAnswer = studyQuestions[currentQuestionIndex].correctAnswer.toLowerCase();
            const isCorrect = userAnswer === correctAnswer;
            
            if (isCorrect) {
                showNotification('Правильно! 🎉', 'success');
                typingAnswer.style.borderColor = 'var(--success)';
            } else {
                showNotification(`Неправильно. Правильный ответ: ${studyQuestions[currentQuestionIndex].correctAnswer}`, 'error');
                typingAnswer.style.borderColor = 'var(--danger)';
            }
            
            // Обновляем статистику карточки
            if (studyQuestions[currentQuestionIndex].cardId) {
                updateCardStats(currentSetId, studyQuestions[currentQuestionIndex].cardId, isCorrect);
            }
            
            // Переходим к следующему вопросу через 1.5 секунды
            setTimeout(() => {
                if (currentQuestionIndex < studyQuestions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    switchMode('cards');
                    showNotification('Сессия завершена! 🎊', 'success');
                }
            }, 1500);
        }

        function playAudioWord() {
            const currentWord = studyQuestions[currentQuestionIndex].audioWord;
            if (currentWord && speechSynthesis) {
                // Останавливаем предыдущее воспроизведение
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(currentWord);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function showNextQuestion() {
            if (currentQuestionIndex < studyQuestions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            } else {
                // Завершаем сессию
                switchMode('cards');
                showNotification('Сессия завершена! 🎊', 'success');
            }
        }

        // Функции для статистики
        function updateStats() {
            if (!currentSetId) return;
            
            const set = sets.find(s => s.id === currentSetId);
            if (!set) return;
            
            const total = set.cards.length;
            const difficult = set.cards.filter(card => card.userDifficulty === 'hard' || card.stats.difficulty === 2).length;
            const studied = set.cards.filter(card => card.stats.studied > 0).length;
            const success = set.stats.totalStudied > 0 ? Math.round((set.stats.correctAnswers / set.stats.totalStudied) * 100) : 0;
            const learnedProgressValue = total > 0 ? Math.round((studied / total) * 100) : 0;
            
            // SRS статистика
            const dueCardsCount = getDueCards().length;
            const masteredCardsCount = set.cards.filter(card => card.srs && card.srs.stage >= 3).length;
            
            totalCards.textContent = total;
            learnedCards.textContent = `${studied}/${total}`;
            difficultCards.textContent = difficult;
            successRate.textContent = `${success}%`;
            learnedProgress.style.width = `${learnedProgressValue}%`;
            dueCards.textContent = dueCardsCount;
            masteredCards.textContent = masteredCardsCount;
            
            // Показываем сложные слова
            if (difficult > 0) {
                difficultWordsSection.style.display = 'block';
                difficultWordsList.innerHTML = '';
                
                set.cards.filter(card => card.userDifficulty === 'hard' || card.stats.difficulty === 2).forEach(card => {
                    const wordElement = document.createElement('div');
                    wordElement.className = 'difficult-word';
                    wordElement.textContent = card.term;
                    wordElement.title = card.definition;
                    difficultWordsList.appendChild(wordElement);
                });
            } else {
                difficultWordsSection.style.display = 'none';
            }
        }

        // Функции для готовых наборов
        function showPredefinedSetsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Выберите готовый набор</h3>
                        <button class="close-btn" id="closePredefinedModal">&times;</button>
                    </div>
                    <div class="sets-list" style="max-height: 400px; overflow-y: auto;">
                        ${predefinedSets.map(set => `
                            <div class="set-item predefined-set" data-id="${set.id}">
                                <div class="set-icon">📚</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${set.name}</div>
                                    <div style="font-size: 12px; color: var(--gray);">${set.cards.length} слов</div>
                                </div>
                                <button class="btn btn-primary add-set-btn">Добавить</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelPredefined">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Обработчики для добавления наборов
            modal.querySelectorAll('.add-set-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const setId = this.closest('.set-item').dataset.id;
                    addPredefinedSet(setId);
                    document.body.removeChild(modal);
                });
            });
            
            modal.querySelector('#closePredefinedModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('#cancelPredefined').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Закрытие по клику вне модального окна
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function addPredefinedSet(setId) {
            const predefinedSet = predefinedSets.find(s => s.id === setId);
            if (!predefinedSet) return;
            
            // Создаем копию набора с новым ID
            const newSet = {
                id: Date.now().toString(),
                name: predefinedSet.name + ' (копия)',
                cards: predefinedSet.cards.map(card => ({
                    ...card,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    stats: {
                        studied: 0,
                        correct: 0,
                        difficulty: 0
                    },
                    userDifficulty: 'easy',
                    srs: {
                        stage: 0,
                        interval: 1,
                        dueDate: new Date(),
                        easeFactor: 2.5,
                        reviews: 0
                    }
                })),
                stats: {
                    totalStudied: 0,
                    correctAnswers: 0,
                    difficultWords: []
                }
            };
            
            sets.push(newSet);
            saveData();
            renderSets();
            selectSet(newSet.id);
            
            showNotification(`Набор "${predefinedSet.name}" успешно добавлен!`, 'success');
        }

        // Функции для экспорта
        function showExportModal() {
            if (!currentSetId) {
                showNotification('Пожалуйста, сначала выберите набор для экспорта', 'error');
                return;
            }
            
            updateExportContent();
            exportModal.classList.add('active');
        }

        function updateExportContent() {
            if (!currentSetId) return;
            
            const currentSet = sets.find(s => s.id === currentSetId);
            if (!currentSet) return;
            
            if (currentExportFormat === 'json') {
                const dataStr = JSON.stringify([currentSet], null, 2);
                exportContent.value = dataStr;
            } else if (currentExportFormat === 'txt') {
                const txtContent = currentSet.cards.map(card => 
                    `${card.term} - ${card.definition}`
                ).join('\n');
                exportContent.value = txtContent;
            }
        }

        function downloadExportFile() {
            if (!currentSetId) return;
            
            const currentSet = sets.find(s => s.id === currentSetId);
            if (!currentSet) return;
            
            let dataStr, fileName, mimeType;
            
            if (currentExportFormat === 'json') {
                dataStr = JSON.stringify([currentSet], null, 2);
                fileName = `think_smile_${currentSet.name.replace(/\s+/g, '_')}.json`;
                mimeType = 'application/json';
            } else if (currentExportFormat === 'txt') {
                dataStr = currentSet.cards.map(card => 
                    `${card.term} - ${card.definition}`
                ).join('\n');
                fileName = `think_smile_${currentSet.name.replace(/\s+/g, '_')}.txt`;
                mimeType = 'text/plain';
            }
            
            const dataBlob = new Blob([dataStr], {type: mimeType});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification(`Набор "${currentSet.name}" успешно экспортирован в формате ${currentExportFormat.toUpperCase()}!`, 'success');
            closeExportModalFunc();
        }

        function closeExportModalFunc() {
            exportModal.classList.remove('active');
        }

        // Функции для импорта
        function showImportModal() {
            importModal.classList.add('active');
            importFileInput.value = '';
            importPreview.style.display = 'none';
            importNameSection.style.display = 'none';
            importFileWarning.style.display = 'none';
            importNameWarning.style.display = 'none';
            confirmImport.disabled = true;
            importSetData = null;
            
            // Сбрасываем формат на JSON
            importFormatButtons.forEach(b => b.classList.remove('active'));
            document.querySelector('.import-format-btn[data-format="json"]').classList.add('active');
            currentImportFormat = 'json';
            importFileInput.accept = '.json';
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (currentImportFormat === 'json') {
                        handleJsonImport(e.target.result);
                    } else if (currentImportFormat === 'txt') {
                        handleTxtImport(e.target.result, file.name);
                    }
                } catch (error) {
                    importFileWarning.textContent = 'Ошибка чтения файла: ' + error.message;
                    importFileWarning.style.display = 'block';
                    importPreview.style.display = 'none';
                    importNameSection.style.display = 'none';
                    confirmImport.disabled = true;
                }
            };
            reader.readAsText(file);
        }

        function handleJsonImport(fileContent) {
            const data = JSON.parse(fileContent);
            
            // Проверяем формат данных
            if (Array.isArray(data) && data.length > 0 && data[0].name && Array.isArray(data[0].cards)) {
                importSetData = data[0]; // Берем первый набор из файла
                
                // Показываем превью
                previewSetName.textContent = importSetData.name;
                previewCardCount.textContent = importSetData.cards.length;
                
                // Показываем первые слова
                const firstWords = importSetData.cards.slice(0, 3).map(card => card.term).join(', ');
                previewFirstWords.textContent = firstWords + (importSetData.cards.length > 3 ? '...' : '');
                
                importPreview.style.display = 'block';
                importNameSection.style.display = 'block';
                importSetName.value = importSetData.name + ' (импорт)';
                validateImportName();
                importFileWarning.style.display = 'none';
            } else {
                throw new Error('Файл должен содержать корректные данные набора карточек');
            }
        }

        function handleTxtImport(fileContent, fileName) {
            const lines = fileContent.split('\n').filter(line => line.trim());
            const cards = [];
            
            for (const line of lines) {
                // Поддерживаем форматы: "слово - перевод" или "слово: перевод"
                const separator = line.includes(' - ') ? ' - ' : (line.includes(': ') ? ': ' : null);
                
                if (separator) {
                    const [term, definition] = line.split(separator).map(part => part.trim());
                    if (term && definition) {
                        cards.push({
                            term: term,
                            definition: definition,
                            transcription: getTranscription(term)
                        });
                    }
                }
            }
            
            if (cards.length === 0) {
                throw new Error('Не удалось найти карточки в файле. Убедитесь, что формат: "слово - перевод"');
            }
            
            // Создаем временный набор для импорта
            const baseName = fileName.replace(/\.[^/.]+$/, ""); // Убираем расширение файла
            importSetData = {
                name: baseName,
                cards: cards
            };
            
            // Показываем превью
            previewSetName.textContent = importSetData.name;
            previewCardCount.textContent = importSetData.cards.length;
            
            // Показываем первые слова
            const firstWords = importSetData.cards.slice(0, 3).map(card => card.term).join(', ');
            previewFirstWords.textContent = firstWords + (importSetData.cards.length > 3 ? '...' : '');
            
            importPreview.style.display = 'block';
            importNameSection.style.display = 'block';
            importSetName.value = importSetData.name;
            validateImportName();
            importFileWarning.style.display = 'none';
        }

        function validateImportName() {
            const name = importSetName.value.trim();
            if (name) {
                importNameWarning.style.display = 'none';
                confirmImport.disabled = false;
            } else {
                importNameWarning.style.display = 'block';
                confirmImport.disabled = true;
            }
        }

        function confirmImportFunc() {
            if (!importSetData) return;
            
            const name = importSetName.value.trim();
            if (!name) {
                importNameWarning.style.display = 'block';
                return;
            }
            
            // Создаем новый набор на основе импортированных данных
            const newSet = {
                id: Date.now().toString(),
                name: name,
                cards: importSetData.cards.map(card => ({
                    ...card,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    stats: {
                        studied: 0,
                        correct: 0,
                        difficulty: 0
                    },
                    userDifficulty: 'easy',
                    srs: {
                        stage: 0,
                        interval: 1,
                        dueDate: new Date(),
                        easeFactor: 2.5,
                        reviews: 0
                    }
                })),
                stats: {
                    totalStudied: 0,
                    correctAnswers: 0,
                    difficultWords: []
                }
            };
            
            sets.push(newSet);
            saveData();
            renderSets();
            selectSet(newSet.id);
            
            showNotification(`Набор "${name}" успешно импортирован! Добавлено ${newSet.cards.length} карточек.`, 'success');
            closeImportModalFunc();
        }

        function closeImportModalFunc() {
            importModal.classList.remove('active');
            importFileInput.value = '';
            importPreview.style.display = 'none';
            importNameSection.style.display = 'none';
            importFileWarning.style.display = 'none';
            importNameWarning.style.display = 'none';
            confirmImport.disabled = true;
            importSetData = null;
        }

        // Функции для модального окна удаления
        function showDeleteSetModal(setId, setName) {
            deleteModalTitle.textContent = 'Удалить набор';
            deleteModalMessage.textContent = `Вы уверены, что хотите удалить набор "${setName}"? Это действие нельзя отменить.`;
            deleteSetId = setId;
            confirmDeleteModal.classList.add('active');
        }

        function closeConfirmDeleteModalFunc() {
            confirmDeleteModal.classList.remove('active');
            deleteSetId = null;
        }

        function confirmDeleteFunc() {
            if (deleteSetId) {
                deleteSet(deleteSetId);
            }
        }

        function closeEditSetModalFunc() {
            editSetModal.classList.remove('active');
            editingSetId = null;
        }

        // Вспомогательные функции
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function saveData() {
            localStorage.setItem('thinkSmileSets', JSON.stringify(sets));
        }

        function closeCreateSetModalFunc() {
            createSetModal.classList.remove('active');
            setNameInput.value = '';
            setNameWarning.style.display = 'none';
        }

        function closeCreateCardModalFunc() {
            createCardModal.classList.remove('active');
            cardTermInput.value = '';
            cardDefinitionInput.value = '';
            cardTermWarning.style.display = 'none';
            cardDefinitionWarning.style.display = 'none';
            editingCardId = null;
        }

        function showEmptyState() {
            emptyState.style.display = 'block';
            cardsContainer.style.display = 'none';
            cardsList.style.display = 'none';
            studyContainer.classList.remove('active');
            statsContainer.style.display = 'none';
            searchFilterContainer.style.display = 'none';
            viewModeSelector.style.display = 'none';
        }

        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Показываем уведомление
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Автоматическое скрытие через 3 секунды
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Инициализация голосов при загрузке
        speechSynthesis.onvoiceschanged = function() {
            console.log('Голоса загружены:', speechSynthesis.getVoices().length);
        };

        // Запуск приложения
        init();
    </script>
</body>
</html>
